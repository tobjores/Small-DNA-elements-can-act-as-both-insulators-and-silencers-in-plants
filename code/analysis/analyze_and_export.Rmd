---
title: "Context-dependent activity of enhancer-blocking insulators in plants"
output:
  html_document:
    df_print: paged
---

This notebook contains all code used for the analysis used in the paper [Context-dependent activity of enhancer-blocking insulators in plants](https://www.biorxiv.org/). It relies on data generated by the scripts `process_barcode_counts.R` and `process_dual-luciferase.R`. Run these two first, if you haven't done so already.

```{r setup, include = FALSE}
### set options for this notebook ###
knitr::opts_chunk$set(results = 'hide')

### prepare the R environment ###
# load libraries
library(tidyverse)
library(openxlsx)

# load functions to export the plot data
source('pggfplot.R')

pggf_config(out_dir = '../../figures/rawData/')

# define styles for exported excel tables
xlsx_bold <- createStyle(textDecoration = 'bold')
xlsx_wrap <- createStyle(wrapText = TRUE)
xlsx_boldwrap <- createStyle(textDecoration = 'bold', wrapText = TRUE)
xlsx_2digit <- createStyle(numFmt = '0.00')
xlsx_seq_font <- createStyle(fontName = 'Courier New')
xlsx_center <- createStyle(halign = 'center')

supp_data_dir <- '../../data/supplementary_data/'

# load data
sapply(dir(path = '../../data/Rdata/', pattern = '*.Rdata', full.names = TRUE), load, environment())

# load full-length insulator sequences
FLins_seqs <- read_lines('../../data/refseq/FL_insulators.fa')
FLins_seqs <- tibble(
  id = substring(FLins_seqs[seq(1, length(FLins_seqs), 2)], 2),
  sequence = FLins_seqs[seq(2, length(FLins_seqs), 2)]
) |>
  deframe()

# helpers to order data
insulator_order <- c('noEnh', 'noIns', 'beta-phaseolin', 'TBS', 'lambda-EXOB', 'BEAD-1C', 'UASrpg', 'sIns1', 'sIns2', 'gypsy')
```

## Full-length insulators

Let's start by analyzing the **FLins** library containing full-length insulators. First we will check the replicate correlation to ensure that the data is reliable.

```{r FLins replicate correlation}
data_FLins_norm |>
  select(rep, sys, barcode, insulator, orientation, enrichment) |>
  filter(rep %in% c(1, 2)) |>
  pivot_wider(
    names_from = rep,
    names_prefix = 'rep',
    values_from = enrichment
  ) |>
  drop_na(starts_with('rep')) |>
  pggfplot(
    filename = 'FLins_cor_rep',
    x = rep1,
    y = rep2,
    facet_col = sys,
    scales = 'square'
  ) |>
  pggf_scatter(color = insulator) |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

Next, we create box plots for the enrichment of all barcodes linked to a given insulator.

```{r FLins box plot}
data_FLins_norm |>
  mutate(
    sample = if_else(is.na(orientation), insulator, orientation),
    orientation = case_match(
      insulator,
      'noEnh' ~ 'fwd',
      'noIns' ~ 'rev',
      .default = orientation
    ),
    insulator_label = if_else(insulator %in% c('noEnh', 'noIns'), 'controls', insulator),
    insulator_label = ordered(insulator_label, levels = c('controls', insulator_order)),
    insulator_label = droplevels(insulator_label)
  ) |>
  pggfplot(
    filename = 'FLins_enrichment',
    x = insulator_label,
    y = enrichment,
    facet_col = sys
  ) |>
  pggf_hline(median(y[sample == 'noIns'])) |>
  pggf_boxplot(
    group = orientation,
    extra_cols = c(insulator, sample)
  )
```

## Insulator fragments

In the **iLib** library, We tested the activity of 170-bp fragments derived from the insulators in the **FLins** library. First we will check the replicate correlation to ensure that the data is reliable.

```{r iLib replicate correlation}
data_iLib_norm |>
  select(rep, sys, enhancer, insulator, start, stop, orientation, enrichment) |>
  filter(rep %in% c(1, 2)) |>
  pivot_wider(
    names_from = rep,
    names_prefix = 'rep',
    values_from = enrichment
  ) |>
  drop_na(starts_with('rep')) |>
  pggfplot(
    filename = 'iLib_cor_rep',
    x = rep1,
    y = rep2,
    facet_col = sys,
    scales = 'square'
  ) |>
  pggf_scatter(color = enhancer) |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

Then we create a violin plot to look at the distribution of enrichment values for all insulator fragment-containing constructs with a given enhancer.

```{r iLib violin plot}
data_iLib_mean |>
  group_by(sys, enhancer) |>
  mutate(
    noIns = enrichment[str_sub(insulator, 1, 2) == 'no']
  ) |>
  ungroup() |>
  filter(str_sub(insulator, 1, 2) != 'no') |>
  pggfplot(
    filename = 'iLib_enrichment',
    x = enhancer,
    y = enrichment,
    facet_col = sys,
    scales = 'free_x',
    space = 'free_x'
  ) |>
  pggf_violin(
    extra_cols = noIns
  )
```

The activity of the insulator fragments is dependent on the assay systems.

```{r iLib correlation species}
data_iLib_mean |>
  select(sys, insulator, start, orientation, enhancer, enrichment) |>
  filter(enhancer == '35S') |>
  pivot_wider(
    names_from = sys,
    values_from = enrichment
  ) |>
  drop_na(tobacco, maize) |>
    pggfplot(
    filename = 'iLib_cor_species',
    x = tobacco,
    y = maize
  ) |>
  pggf_scatter() |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

Plotting enrichment of insulator fragments by their position within the full-length insulator:

```{r iLib enrichment by position}
data_iLib_mean |>
  filter(enhancer == '35S') |>
  mutate(
    start = if_else(orientation == 'fwd', start - 0.5, stop + 0.5),
    length = if_else(orientation == 'fwd', 170, -170)
  ) |>
  group_by(sys) |>
  mutate(
    noIns = enrichment[insulator == 'noIns']
  ) |>
  ungroup() |>
  filter(insulator != 'noIns') |>
  pggfplot(
    filename = 'iLib_position',
    x = start,
    y = enrichment,
    facet_col = insulator,
    facet_row = sys,
    scales = 'free',
    space = 'free_x',
    enlarge_x = 0,
    ymin = 0,
    ymax = data_iLib_mean |>
      filter(enhancer == '35S' & insulator == 'noIns') |>
      arrange(sys) |>
      pull(enrichment)
  ) |>
  pggf_hline(unique(noIns)) |>
  pggf_quiver(u = length)
```

GC content is a major contributor to insulator activity.

```{r iLib GC correlation}
data_iLib_mean |>
  filter(enhancer == '35S') |>
  group_by(sys) |>
  mutate(
    noIns = enrichment[insulator == 'noIns']
  ) |>
  ungroup() |>
  drop_na(GC, enrichment) |>
  pggfplot(
    filename = 'iLib_cor_GC',
    x = GC,
    y = enrichment,
    facet_col = sys,
    ymin = 0
  ) |>
  pggf_hline(unique(noIns)) |>
  pggf_scatter() |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

The activity of the insulator fragments is largely independent of which enhancer sits upstream:

```{r iLib correlation across enhancers}
data_iLib_mean |>
  select(sys, insulator, start, orientation, enhancer, enrichment) |>
  filter(enhancer != 'none' & sys == 'tobacco') |>
  pivot_wider(
    names_from = enhancer,
    values_from = enrichment
  ) |>
  pivot_longer(
    c(AB80, `Cab-1`),
    names_to = 'enh2',
    values_to = 'enrichment'
  ) |>
  drop_na(`35S`, enrichment) |>
  mutate(
    type = if_else(insulator == 'noIns', 'control', 'fragments'),
  ) |>
  pggfplot(
    filename = 'iLib_cor_enh',
    x = enrichment,
    y = `35S`,
    facet_col = enh2
  ) |>
  pggf_scatter(
    split = type
  ) |>
  pggf_stats(!! pggf_stat_fns$correlation) |>
  pggf_abline(intercept = y[type == 'control'] - x[type == 'control'])
```

Export data to a Supplementary Data file:

```{r iLib SuppData}
DS_id <- 1

data_iLib_export <- data_iLib_mean |>
  select(sys, enhancer, insulator, start, stop, orientation, enrichment) |>
  pivot_wider(
    names_from = sys,
    values_from = enrichment
  ) |>
  arrange(enhancer, insulator, orientation, start) |>
  mutate(
    sequence = str_sub(FLins_seqs[as.character(insulator)], start, stop),
    sequence = if_else(
      orientation == 'rev',
      as.character(Biostrings::reverseComplement(Biostrings::DNAStringSet(replace_na(sequence, 'A')))),
      sequence
    ),
    sequence = replace_na(sequence, ''),
    insulator = str_replace(insulator, 'beta', 'β'),
    insulator = str_replace(insulator, 'lambda', 'λ')
  )

wb <- createWorkbook()

modifyBaseFont(wb, fontSize = 10, fontName = 'Arial')

addWorksheet(wb, sheetName = 'insulator fragments')

writeData(
  wb,
  sheet = 1,
  paste0('Supplementary Data ', DS_id,' | Enrichment of insulator fragment constructs.'),
  startCol = 1,
  startRow = 1
)

addStyle(wb, sheet = 1, style = xlsx_bold, rows = 1, cols = 1)
mergeCells(wb, sheet = 1, rows = 1, cols = seq_len(ncol(data_iLib_export)))

writeData(
  wb,
  sheet = 1,
  paste(
    "Known insulators were split into partially overlapping 170-bp fragments. The insulator fragments were cloned in the forward or reverse",
    "orientation between a 35S, AB80, or Cab-1 enhancer and a 35S minimal promoter driving the expression of a barcoded GFP reporter gene.",
    "Constructs without an enhancer (none) but with insulator fragments were also created. All insulator fragment constructs were pooled and",
    "subjected to Plant STARR-seq in tobacco leaves (tobacco) and maize protoplasts (maize). Reporter mRNA enrichment was normalized to a",
    "control construct without an enhancer or insulator (noEnh; log2 set to 0)."
  ),
  startCol = 1,
  startRow = 2
)

addStyle(wb, sheet = 1, style = xlsx_wrap, rows = 2, cols = 1)
mergeCells(wb, sheet = 1, rows = 2, cols = seq_len(ncol(data_iLib_export)))
setRowHeights(wb, sheet = 1, rows = 2, heights = 12.75 * 6)

xlsx_header <- names(data_iLib_export)
enrichment_ids <- which(xlsx_header %in% c('tobacco', 'maize'))
xlsx_header[enrichment_ids] <- 'log2(enrichment)'

writeData(
  wb,
  sheet = 1,
  matrix(xlsx_header, nrow = 1),
  startCol = 1,
  startRow = 4,
  colNames = FALSE
)

addStyle(wb, sheet = 1, style = xlsx_boldwrap, cols = seq_along(xlsx_header), rows = 4)

writeData(
  wb,
  sheet = 1,
  data_iLib_export,
  startCol = 1,
  startRow = 5,
  headerStyle = xlsx_bold,
  keepNA = TRUE
)

mergeCells(wb, sheet = 1, rows = 4, cols = enrichment_ids)
addStyle(wb, sheet = 1, style = xlsx_center, rows = 4, cols = enrichment_ids, stack = TRUE)

for (i in seq_along(xlsx_header)[-enrichment_ids]) {
  mergeCells(wb, sheet = 1, rows = 4:5, cols = i)
}

addStyle(wb, sheet = 1, style = xlsx_2digit, cols = enrichment_ids, rows = 6:(nrow(data_iLib_export) + 6), gridExpand = TRUE)
addStyle(wb, sheet = 1, style = xlsx_seq_font, cols = which(xlsx_header == 'sequence'), rows = 6:(nrow(data_iLib_export) + 6))

freezePane(wb, sheet = 1, firstActiveRow = 6)

saveWorkbook(wb, paste0(supp_data_dir, 'SupplementaryData', DS_id, '.xlsx'), overwrite = TRUE)
```

## Insulators in stable lines
We tested some full-length insulators and insulator fragments in stable *Arabidopsis*, maize, and rice lines.

Let's start with full-length insulators in *Arabidopsis*. They were tested with two different enhancers: the 35S and the *AB80* enhancer.

```{r FLins dual-luciferase assay}
data_DL |>
  filter(set %in% c('FLins', 'insAB')) |>
  pggfplot(
    filename = 'DL_FLins_Arabidopsis',
    x = insulator,
    y = l2ratio,
    facet_col = enhancer,
    scales = 'free_x',
    space = 'free_x'
  ) |>
  pggf_hline(median(y[xticklabels == 'noIns'])) |>
  pggf_boxplot()
```

These results closely match our Plant STARR-seq measurements in tobacco.

```{r FLins dual-luciferase correlation dicots}
data_DL_FLins_tobacco_summary <- data_DL |>
  filter(set %in% c('FLins', 'insAB')) |>
  group_by(enhancer, insulator) |>
  summarise(
    CI = 0.5 * diff(t.test(l2ratio)$conf.int),
    l2ratio = mean(l2ratio),
    .groups = 'drop'
  )

data_FLins_norm |>
  filter(sys == 'tobacco' & (insulator %in% c('noEnh', 'noIns') | orientation == 'fwd')) |>
  mutate(
    enhancer = if_else(insulator == 'noEnh', '35S', enhancer)
  ) |>
  bind_rows(
    data_ExI_norm |>
      mutate(
        enhancer = if_else(insulator == 'noEnh', 'AB80', enhancer)
      ) |>
      filter(sys == 'tobacco' & enhancer == 'AB80' & type %in% c('control', 'FL'))
  ) |>
  group_by(enhancer, insulator) |>
  summarise(
    enrichment = mean(enrichment),
    .groups = 'drop'
  ) |>
  inner_join(
    data_DL_FLins_tobacco_summary,
    by = c('enhancer', 'insulator')
  ) |>
  pggfplot(
    filename = 'DL_cor_Flins_Arabidopsis',
    x = enrichment,
    y = l2ratio,
    facet_col = enhancer,
    scales = 'free_x'
  ) |>
  pggf_trendline() |>
  pggf_scatter(
    color = insulator,
    y_error = CI
  ) |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

We also tested the novel synthetic insulators in stable rice lines.

```{r FLins dual-luciferase assay in rice}
data_DL |>
  filter(set == 'rice') |>
  pggfplot(
    filename = 'DL_FLins_rice',
    x = insulator,
    y = l2ratio,
    facet_col = enhancer,
    scales = 'free_x',
    space = 'free_x'
  ) |>
  pggf_hline(median(y[xticklabels == 'noIns'])) |>
  pggf_boxplot()
```

These results closely match our Plant STARR-seq measurements in maize.

```{r FLins dual-luciferase correlation monocots}
data_DL_FLins_tobacco_summary <- data_DL |>
  filter(set == 'rice') |>
  group_by(insulator) |>
  summarise(
    CI = 0.5 * diff(t.test(l2ratio)$conf.int),
    l2ratio = mean(l2ratio),
    .groups = 'drop'
  )

data_FLins_norm |>
  filter(sys == 'maize' & (insulator %in% c('noEnh', 'noIns') | orientation == 'fwd')) |>
  group_by(insulator) |>
  summarise(
    enrichment = mean(enrichment),
    .groups = 'drop'
  ) |>
  inner_join(
    data_DL_FLins_tobacco_summary,
    by = 'insulator'
  ) |>
  pggfplot(
    filename = 'DL_cor_Flins_rice',
    x = enrichment,
    y = l2ratio
  ) |>
  pggf_trendline() |>
  pggf_scatter(
    color = insulator,
    y_error = CI
  ) |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

Insulator fragments were also tested in stable *Arabidopsis* lines.

```{r insulator fragments dual-luciferase activity}
data_DL |>
  filter(set == 'frag') |>
  mutate(
    order = as.numeric(insulator)
  ) |>
  unite(
    'insulator',
    insulator,
    start,
    stop,
    na.rm = TRUE
  ) |>
  mutate(
    insulator = ordered(insulator, levels = unique(insulator[order(order)]))
  ) |>
  pggfplot(
    filename = 'DL_frags_Arabidopsis',
    x = insulator,
    y = l2ratio,
    scales = 'free_x',
    space = 'free_x'
  ) |>
  pggf_hline(median(y[xticklabels == 'noIns'])) |>
  pggf_boxplot()
```

Again, we see a good correlation between results from Plant STARR-seq and stable lines.

```{r insulator fragments dual-luciferase correlation}
data_DL_frags_summary <- data_DL |>
  filter(set == 'frag') |>
  group_by(insulator, start, stop) |>
  summarise(
    CI = 0.5 * diff(t.test(l2ratio)$conf.int),
    l2ratio = mean(l2ratio),
    .groups = 'drop'
  )

data_iLib_mean |>
  filter(sys == 'tobacco' & (insulator %in% c('noEnh', 'noIns') | orientation == 'fwd')) |>
  group_by(insulator, start) |>
  summarise(
    enrichment = mean(enrichment),
    .groups = 'drop'
  ) |>
  inner_join(
    data_DL_frags_summary,
    by = c('insulator', 'start'),
  ) |>
  mutate(
    order = as.numeric(insulator)
  ) |>
  unite(
    'insulator',
    insulator,
    start,
    stop,
    na.rm = TRUE
  ) |>
  mutate(
    insulator = ordered(insulator, levels = unique(insulator[order(order)]))
  ) |>
  pggfplot(
    filename = 'DL_cor_frags_Arabidopsis',
    x = enrichment,
    y = l2ratio
  ) |>
  pggf_trendline() |>
  pggf_scatter(
    color = insulator,
    y_error = CI
  ) |>
  pggf_stats(!! pggf_stat_fns$correlation)
  
```

Finally, insulator fragments were also tested in stable maize lines using ELISA as a readout.

```{r insulator fragments in stable maize lines}
data_ELISA <- read_tsv('../../data/Corteva/insulator_fragments_maize.tsv', show_col_types = FALSE) |>
  separate_wider_delim(
    id,
    delim = '_',
    names = c('insulator', 'start', 'end', 'orientation'),
    too_few = 'align_start'
  ) |>
  mutate(
    tmp = start,
    start = if_else(orientation == 'rev', end, start),
    end = if_else(orientation == 'rev', tmp, end)
  ) |>
  unite(
    'id',
    insulator,
    start,
    end,
    na.rm = TRUE,
    remove = FALSE
  ) |>
  select(-tmp)

insFrag_order <- data_ELISA |>
  distinct(id, insulator, start) |>
  mutate(
    insulator = ordered(insulator, levels = insulator_order),
    start = as.numeric(start)
  ) |>
  arrange(insulator, start) |>
  pull(id)

# plot for R1 leaves
data_ELISA |>
  mutate(
    id = ordered(id, levels = insFrag_order)
  ) |>
  rename('ELISA' = R1_leaf) |>
  drop_na(ELISA) |>
  pggfplot(
    filename = 'ELISA_R1_leaf',
    x = id,
    y = ELISA
  ) |>
  pggf_hline(
    list(c('noIns' = median(y[xticklabels == 'noIns']), 'noEnh' = median(y[xticklabels == 'noEnh'])))
  ) |>
  pggf_boxplot()

# plot for other tissues/developmental stages
data_ELISA |>
  mutate(
    id = ordered(id, levels = insFrag_order)
  ) |>
  pivot_longer(
    starts_with(c('V6', 'R1')),
    names_to = 'sample',
    values_to = 'ELISA'
  ) |>
  drop_na(ELISA) |>
  filter(sample != 'R1_leaf') |>
  pggfplot(
    filename = 'ELISA_samples',
    x = id,
    y = ELISA,
    facet_row = sample,
    scales = 'free_y',
    ymin = 0
  ) |>
  pggf_hline(
    list(c('noIns' = median(y[xticklabels == 'noIns']), 'noEnh' = median(y[xticklabels == 'noEnh'])))
  ) |>
  pggf_boxplot()
```

The ELISA results resemble our Plant STARR-seq data in maize.

```{r insulator fragments in maize - correlation}
data_ELISA_summary <- data_ELISA |>
  pivot_longer(
    starts_with(c('V6', 'R1')),
    names_to = 'sample',
    values_to = 'ELISA'
  ) |>
  drop_na(ELISA) |>
  group_by(id, sample) |>
  summarise(
    CI = 0.5 * diff(t.test(ELISA)$conf.int),
    ELISA = mean(ELISA),
    .groups = 'drop'
  )

data_ELISA_summary <- data_iLib_mean |>
  filter(sys == 'maize' & (enhancer == '35S' | insulator == 'noEnh')) |>
  mutate(
    tmp = start,
    start = if_else(orientation == 'rev', stop, start),
    stop = if_else(orientation == 'rev', tmp, stop)
  ) |>
  unite(
    'id',
    insulator,
    start,
    stop,
    na.rm = TRUE,
    remove = FALSE
  ) |>
  select(-tmp) |>
  inner_join(
    data_ELISA_summary,
    by = 'id',
  ) |>
  mutate(
    id = ordered(id, levels = insFrag_order)
  )

# plot for R1 leaves
data_ELISA_summary |>
  filter(sample == 'R1_leaf') |>
  pggfplot(
    filename = 'ELISA_cor_R1_leaf',
    x = enrichment,
    y = ELISA
  ) |>
  pggf_trendline() |>
  pggf_scatter(
    color = id,
    y_error = CI
  ) |>
  pggf_stats(!! pggf_stat_fns$correlation)

# plot for other tissues/developmental stages
data_ELISA_summary |>
  filter(sample != 'R1_leaf') |>
  pggfplot(
    filename = 'ELISA_cor_samples',
    x = enrichment,
    y = ELISA,
    facet_row = sample,
    scales = 'free_y'
  ) |>
  pggf_trendline() |>
  pggf_scatter(
    color = id,
    y_error = CI
  ) |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

We tested the activity of the insulator fragments in several maize tissues and observed strong correlation between the results.

```{r insulator fragments in maize - tissue-specificity}
sample_order <- c('V6_leaf', 'R1_leaf', 'R1_stalk', 'R1_husk', 'R1_silk', 'STARRseq')

ELISA_cor <- data_ELISA_summary |>
  select(id, sample, 'STARRseq' = enrichment, ELISA) |>
  pivot_wider(names_from = sample, values_from = ELISA) |>
  select(all_of(sample_order)) |>
  cor(use = 'complete.obs')

ELISA_cor[! lower.tri(ELISA_cor)] <- NA

ELISA_cor |>
  as_tibble(rownames = 'y') |>
  pivot_longer(
    -y,
    names_to = 'x',
    values_to = 'cor'
  ) |>
  mutate(
    across(c(x, y), ~ ordered(.x, levels = sample_order)),
    rsquare = cor^2
  ) |>
  drop_na(rsquare) |>
  pggfplot(
    filename = 'ELISA_tissues',
    x = x,
    y = y
  ) |>
  pggf_heatmap(
    color = rsquare
  )
```


## Insulator fragment combinations

Insulator fragments block the 35S enhancer only partially. We were wondering if stacking two or three insulator fragments can yield very strong insulators. To this end, we created the **iFC** library in which we tested the enhancer-blocking activity of 32 insulator fragments alone (single insulator constructs) or in all possible pairwise combinations (double insulator constructs). Finally, we also created versions with three insulator fragments (triple insulator constructs) by cloning one of five strong (in tobacco) insulator fragments upstream of the two insulator fragments in the double insulator constructs. Replicate correlations were high for experiments with this library.

```{r iFC replicate correlation}
data_iFC_norm |>
  select(rep, sys, starts_with(c('id_', 'orientation_')), enrichment) |>
  pivot_wider(
    names_from = rep,
    names_prefix = 'rep',
    values_from = enrichment
  ) |>
  drop_na(starts_with('rep')) |>
  pggfplot(
    filename = 'iFC_cor_rep',
    x = rep1,
    y = rep2,
    facet_col = sys,
    scales = 'square'
  ) |>
  pggf_hexbin() |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

Stacking two or more insulator fragments increases the enhancer-blocking effect.

```{r iFC enrichment}
data_iFC_mean |>
  group_by(sys) |>
  mutate(
    n_frags = case_match(
      type,
      'single' ~ '1',
      'double' ~ '2',
      'triple' ~ '3'
    ),
    noIns = enrichment[id_1 == 'noIns']
  ) |>
  ungroup() |>
  filter(type != 'control') |>
  pggfplot(
    filename = 'iFC_enrichment',
    x = n_frags,
    y = enrichment,
    facet_col = sys
  ) |>
  pggf_hline(unique(noIns)) |>
  pggf_violin()
```

To predict the enhancer-blocking activity of insulator fragment combinations, we can build a simple linear model using the activity of the individual fragments (as measured in the iLib library) and there position in the stack as inputs.

```{r iFC linear model}
individual_frags <- data_iLib_mean |>
  filter(enhancer == '35S') |>
  group_by(sys) |>
  mutate(
    activity = enrichment[insulator == 'noIns'] - enrichment
  ) |>
  ungroup() |>
  filter(! grepl('no', insulator, fixed = TRUE)) |>
  unite(
    'fragment',
    insulator,
    start,
    orientation,
    sys
  ) |>
  select(fragment, activity) |>
  deframe()


iFC_models <- data_iFC_mean |>
  unite(
    'fragment_1',
    id_1,
    orientation_1,
    sys,
    na.rm = TRUE,
    remove = FALSE
  ) |>
  unite(
    'fragment_2',
    id_2,
    orientation_2,
    sys,
    na.rm = TRUE,
    remove = FALSE
  ) |>
  unite(
    'fragment_3',
    id_3,
    orientation_3,
    sys,
    na.rm = TRUE,
    remove = FALSE
  ) |>
  group_by(sys) |>
  mutate(
    noIns = enrichment[id_1 == 'noIns'],
    activity = noIns - enrichment,
    across(starts_with('fragment_'), ~ individual_frags[.x]),
    across(starts_with('fragment_'), ~ replace_na(.x, 0))
  ) |>
  ungroup() |>
  filter(! is.na(id_2)) |>
  nest_by(sys, noIns) |>
  reframe(
    model = list(lm(activity ~ fragment_1 + fragment_2 + fragment_3, data = data)),
    enrichment = data$enrichment,
    prediction = noIns - predict(model, data = data),
    coefficients = list(coef(model))
  ) |>
  select(-model, -noIns)

iFC_models |>
  pggfplot(
    filename = 'iFC_cor_prediction',
    x = prediction,
    y = enrichment,
    facet_col = sys,
    scales = 'square'
  ) |>
  pggf_hexbin() |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

The coefficients of the model reveal that the fragment closest to the minimal promoter (and furthest away from the enhancer) has the strongest impact on overall enhancer-blocking activity.

```{r iFC model coefficients}
iFC_models |>
  distinct(sys, coefficients) |>
  unnest_longer(coefficients) |>
  filter(coefficients_id != '(Intercept)') |>
  mutate(
    position = case_match(
      coefficients_id,
      'fragment_1' ~ '3',
      'fragment_2' ~ '2',
      'fragment_3' ~ '1'
    )
  ) |>
  pggfplot(
    filename = 'iFC_model_coef',
    x = position,
    y = coefficients
  ) |>
  pggf_bar(
    group = sys
  )
```

Export data to a Supplementary Data file:

```{r iFC SuppData}
DS_id <- 2

expand_id <- function(id) {
  df <- tibble(
    insulator = str_replace(id, '_.*', ''),
    start = as.numeric(str_extract(id, '(?<=_)[0-9]+')),
    stop = start + 169,
    orientation = str_replace(id, '.*_', ''),
    sequence = str_sub(FLins_seqs[insulator], start, stop),
  ) |>
    mutate(
      sequence = if_else(
        orientation == 'rev',
        as.character(Biostrings::reverseComplement(Biostrings::DNAStringSet(replace_na(sequence, 'A')))),
        sequence
      )
    ) |>
    unite(
      'fragment',
      insulator,
      start,
      stop,
      orientation,
      na.rm = TRUE
    )

  return(df)
}

data_iFC_export <- data_iFC_mean |>
  unite(
    'id_1',
    id_1,
    orientation_1,
    na.rm = TRUE
  ) |>
  unite(
    'id_2',
    id_2,
    orientation_2,
    na.rm = TRUE
  ) |>
  unite(
    'id_3',
    id_3,
    orientation_3,
    na.rm = TRUE
  ) |>
  mutate(
    n_frags = case_match(
      type,
      'single' ~ 1,
      'double' ~ 2,
      'triple' ~ 3,
      .default = 0
    )
  ) |>
  mutate(
    across(starts_with('id'), ~ if_else(.x == '', NA, .x)),
    across(starts_with('id'), expand_id, .unpack = '{inner}_{str_replace(outer, "id_", "")}')
  ) |>
  mutate(
    sequence_3 = if_else(is.na(sequence_3), '', paste0(sequence_3, 'actc')),
    sequence_2 = if_else(is.na(sequence_2), '', paste0(sequence_2, 'ctgt')),
    sequence_1 = replace_na(sequence_1, ''),
    sequence = paste0(sequence_3, sequence_2, sequence_1),
  ) |>
  select(sys, n_frags, starts_with('fragment'), enrichment, sequence) |>
  pivot_wider(
    names_from = sys,
    values_from = enrichment
  ) |>
  arrange(-n_frags, fragment_3, fragment_2, fragment_1) |>
  select('number of fragments' = n_frags, 'fragment 3' = fragment_3, 'fragment 2' = fragment_2, 'fragment 1' = fragment_1, tobacco, maize, sequence) |>
  mutate(
    across(starts_with('fragment'), ~ str_replace(.x, 'beta', 'β')),
    across(starts_with('fragment'), ~ str_replace(.x, 'lambda', 'λ')),
  )

wb <- createWorkbook()

modifyBaseFont(wb, fontSize = 10, fontName = 'Arial')

addWorksheet(wb, sheetName = 'insulator fragment combinations')

writeData(
  wb,
  sheet = 1,
  paste0('Supplementary Data ', DS_id,' | Enrichment of insulator fragment combination constructs.'),
  startCol = 1,
  startRow = 1
)

addStyle(wb, sheet = 1, style = xlsx_bold, rows = 1, cols = 1)
mergeCells(wb, sheet = 1, rows = 1, cols = seq_len(ncol(data_iFC_export)))

writeData(
  wb,
  sheet = 1,
  paste(
    "One, two, or three 170-bp fragments of known insulators were cloned between a 35S enhancer and a 35S minimal promoter driving the",
    "expression of a barcoded GFP reporter gene. All insulator constructs were pooled and subjected to Plant STARR-seq in tobacco leaves",
    "(tobacco) and maize protoplasts (maize). Reporter mRNA enrichment was normalized to a control construct without an enhancer or insulator",
    "(log2 set to 0)."
  ),
  startCol = 1,
  startRow = 2
)

addStyle(wb, sheet = 1, style = xlsx_wrap, rows = 2, cols = 1)
mergeCells(wb, sheet = 1, rows = 2, cols = seq_len(ncol(data_iFC_export)))
setRowHeights(wb, sheet = 1, rows = 2, heights = 12.75 * 4)

xlsx_header <- names(data_iFC_export)
enrichment_ids <- which(xlsx_header %in% c('tobacco', 'maize'))
xlsx_header[enrichment_ids] <- 'log2(enrichment)'

writeData(
  wb,
  sheet = 1,
  matrix(xlsx_header, nrow = 1),
  startCol = 1,
  startRow = 4,
  colNames = FALSE
)

addStyle(wb, sheet = 1, style = xlsx_boldwrap, cols = seq_along(xlsx_header), rows = 4)

writeData(
  wb,
  sheet = 1,
  data_iFC_export,
  startCol = 1,
  startRow = 5,
  headerStyle = xlsx_bold,
  keepNA = TRUE
)

mergeCells(wb, sheet = 1, rows = 4, cols = enrichment_ids)
addStyle(wb, sheet = 1, style = xlsx_center, rows = 4, cols = enrichment_ids, stack = TRUE)

for (i in seq_along(xlsx_header)[-enrichment_ids]) {
  mergeCells(wb, sheet = 1, rows = 4:5, cols = i)
}

addStyle(wb, sheet = 1, style = xlsx_2digit, cols = enrichment_ids, rows = 6:(nrow(data_iFC_export) + 6), gridExpand = TRUE)
addStyle(wb, sheet = 1, style = xlsx_seq_font, cols = which(xlsx_header == 'sequence'), rows = 6:(nrow(data_iFC_export) + 6))

setColWidths(wb, sheet = 1, cols = grep('fragment ', xlsx_header), widths = 24)

freezePane(wb, sheet = 1, firstActiveRow = 6)

saveWorkbook(wb, paste0(supp_data_dir, 'SupplementaryData', DS_id, '.xlsx'), overwrite = TRUE)
```


### Insulator fragment combinations in stable maize lines

Similar to the single insulator fragments, we also tested several insulator fragment combinations in stable maize lines.

```{r iFC in stable maize - ELISA}
data_ELISA_iFC <- read_tsv('../../data/Corteva/stacked_insulators_maize.tsv', show_col_types = FALSE) |>
  separate_wider_delim(
    id,
    delim = '+',
    names_sep = '_',
    too_few = 'align_end'
  ) |>
  mutate(
    across(
      starts_with('id_'),
      ~ if_else(
        str_detect(.x, '_rev'),
        str_match_all(.x, '(.*)_(.*)_(.*)_(.*)') |> sapply(function(x) paste(x[2], x[4], x[3], x[5], sep = '_')),
        .x
      )
    )
  ) |> 
  rename_with(~ paste0('id_', 6 - as.numeric(str_sub(.x, 4))), starts_with('id_')) |>
  unite(
    'id',
    starts_with('id_'),
    sep = '+',
    na.rm = TRUE,
    remove = FALSE
  ) |>
  mutate(
    n_frags = case_when(
      ! is.na(id_5) ~ 5,
      ! is.na(id_3) ~ 3,
      ! is.na(id_2) ~ 2
    )
  ) |>
  filter(short_id != 'T17') # only three independent lines for T17

stackedIns_order <- c(
  'noEnh',
  'noIns',
  data_ELISA_iFC |>
    filter(! id %in% c('noEnh', 'noIns')) |>
    group_by(short_id, n_frags) |>
    summarise(
      rank = median(R1_leaf),
      .groups = 'drop'
    ) |>
    arrange(n_frags, -rank) |>
    pull(short_id)
)

# plot for R1 leaves
data_ELISA_iFC |>
  mutate(
    short_id = ordered(short_id, levels = stackedIns_order)
  ) |>
  rename('ELISA' = R1_leaf) |>
  drop_na(ELISA) |>
  pggfplot(
    filename = 'ELISA_stacked_R1_leaf',
    x = short_id,
    y = ELISA
  ) |>
  pggf_hline(
    list(c('noIns' = median(y[xticklabels == 'noIns']), 'noEnh' = median(y[xticklabels == 'noEnh'])))
  ) |>
  pggf_boxplot()

# plot for other tissues/developmental stages
data_ELISA_iFC |>
  mutate(
    short_id = ordered(short_id, levels = stackedIns_order)
  ) |>
  pivot_longer(
    starts_with(c('V6', 'R1')),
    names_to = 'sample',
    values_to = 'ELISA'
  ) |>
  drop_na(ELISA) |>
  filter(sample != 'R1_leaf') |>
  pggfplot(
    filename = 'ELISA_stacked_samples',
    x = short_id,
    y = ELISA,
    facet_row = sample,
    scales = 'free_y',
    ymin = 0
  ) |>
  pggf_hline(
    list(c('noIns' = median(y[xticklabels == 'noIns']), 'noEnh' = median(y[xticklabels == 'noEnh'])))
  ) |>
  pggf_boxplot()
```

We can compare these results to the Plant STARR-seq data:

```{r iFC in stable maize - ELISA correlation}
data_ELISA_iFC_summary <- data_ELISA_iFC |>
  filter(is.na(id_4)) |>
  select(-c(id_4, id_5)) |>
  pivot_longer(
    starts_with(c('V6', 'R1')),
    names_to = 'sample',
    values_to = 'ELISA'
  ) |>
  drop_na(ELISA) |>
  group_by(pick(contains('id')), sample) |>
  summarise(
    CI = 0.5 * diff(t.test(ELISA)$conf.int),
    ELISA = mean(ELISA),
    .groups = 'drop'
  ) |>
  mutate(
    across(
      starts_with('id_'),
      ~ if_else(
        is.na(.x) | .x %in% c('noEnh', 'noIns'),
        .x,
        str_match_all(.x, '(.*)_(.*)_(.*)_(.*)') |>
          sapply(function(x) paste0(x[2], '_', if_else(x[5] == 'rev', x[4], x[3]), '|', x[5]))
      )
    )
  ) |>
  separate_wider_delim(
    id_1,
    delim = '|',
    names = c('id_1', 'orientation_1'),
    too_few = 'align_start'
  ) |>
  separate_wider_delim(
    id_2,
    delim = '|',
    names = c('id_2', 'orientation_2'),
    too_few = 'align_start'
  ) |>
  separate_wider_delim(
    id_3,
    delim = '|',
    names = c('id_3', 'orientation_3'),
    too_few = 'align_start'
  ) |>
  inner_join(
    data_iFC_mean |>
      filter(sys == 'maize' & type != 'single') |>
      select(id_1, orientation_1, id_2, orientation_2, id_3, orientation_3, enrichment),
    join_by(id_1, orientation_1, id_2, orientation_2, id_3, orientation_3)
  ) |>
  mutate(
    short_id = ordered(short_id, levels = stackedIns_order)
  )

# plot for R1 leaves
data_ELISA_iFC_summary |>
  filter(sample == 'R1_leaf') |>
  pggfplot(
    filename = 'ELISA_stacked_cor_R1_leaf',
    x = enrichment,
    y = ELISA
  ) |>
  pggf_trendline() |>
  pggf_scatter(
    color = short_id,
    y_error = CI
  ) |>
  pggf_stats(!! pggf_stat_fns$correlation)

# plot for other tissues/developmental stages
data_ELISA_iFC_summary |>
  filter(sample != 'R1_leaf') |>
  pggfplot(
    filename = 'ELISA_stacked_cor_samples',
    x = enrichment,
    y = ELISA,
    facet_row = sample,
    scales = 'free_y'
  ) |>
  pggf_trendline() |>
  pggf_scatter(
    color = short_id,
    y_error = CI
  ) |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

Calculate correlation between insulator activity in various tissues and compare with Plant STARR-seq:

```{r iFC in stable maize - tissue-specificity}
sample_order <- c('V6_leaf', 'R1_leaf', 'R1_stalk', 'R1_husk', 'R1_silk', 'V6_root_tip', 'V6_root_mature', 'STARRseq')

ELISA_cor <- data_ELISA_iFC_summary |>
  select(id, sample, 'STARRseq' = enrichment, ELISA) |>
  pivot_wider(names_from = sample, values_from = ELISA) |>
  select(any_of(sample_order)) |>
  cor(use = 'complete.obs') 

ELISA_cor[! lower.tri(ELISA_cor)] <- NA

ELISA_cor |>
  as_tibble(rownames = 'y') |>
  pivot_longer(
    -y,
    names_to = 'x',
    values_to = 'cor'
  ) |>
  mutate(
    across(c(x, y), ~ ordered(.x, levels = sample_order)),
    rsquare = cor^2
  ) |>
  drop_na(rsquare) |>
  pggfplot(
    filename = 'ELISA_stacked_tissues',
    x = x,
    y = y
  ) |>
  pggf_heatmap(
    color = rsquare
  )
```


## Downstream enhancers

Since the distance to the minimal promoter seems to affect the activity of the insulator fragments, we tested if they can still function when we insert a second enhancer between the insulator fragments and the minimal promoter. This gave rise to the **iDE** library. As for previous libraries, replicate correlations were high for this library.

```{r iDE replicate correlation}
data_iDE_norm |>
  select(rep, sys, enh_up, enh_down, insulator, start, stop, orientation, enrichment) |>
  filter(enh_down != 'none') |>
  pivot_wider(
    names_from = rep,
    names_prefix = 'rep',
    values_from = enrichment
  ) |>
  drop_na(starts_with('rep')) |>
  pggfplot(
    filename = 'iDE_cor_rep',
    x = rep1,
    y = rep2,
    scales = 'square'
  ) |>
  pggf_scatter(color = enh_up) |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

Insulator fragments reduce the enrichment of the reporter construct with and without the upstream 35S enhancer.

```{r iDE enrichment}
data_iDE_mean |>
  filter(enh_down != 'none') |>
  group_by(enh_up, enh_down) |>
  mutate(
    noIns = enrichment[insulator == 'noIns']
  ) |>
  ungroup() |>
  filter(! insulator %in% c('noEnh', 'noIns')) |>
  mutate(
    enh_up = if_else(enh_up == '35S', 'with', 'without'),
    enh_up = ordered(enh_up, levels = c('with', 'without'))
  ) |>
  pggfplot(
    filename = 'iDE_enrichment',
    x = enh_down,
    y = enrichment,
    facet_col = enh_up
  ) |>
  pggf_violin(
    extra_cols = noIns
  )
```

Insulator activity is similar with and without the downstream enhancer.

```{r iDE correlation with iLib}
data_iDE_mean |>
  filter(enh_up == '35S' & enh_down != 'none') |>
  select(insulator, start, stop, orientation, enh_down, enrichment) |>
  inner_join(
    data_iLib_mean |>
      filter(sys == 'tobacco' & enhancer == '35S') |>
      select(insulator, start, stop, orientation, enrichment),
    by = c('insulator', 'start', 'stop', 'orientation'),
    suffix = c('_iDE', '_iLib')
  ) |>
  drop_na(starts_with('enrichment')) |>
  mutate(
    type = if_else(insulator == 'noIns', 'control', 'fragments'),
  ) |>
  pggfplot(
    filename = 'iDE_cor_iLib',
    x = enrichment_iDE,
    y = enrichment_iLib,
    facet_col = enh_down
  ) |>
  pggf_scatter(
    split = type
  ) |>
  pggf_stats(!! pggf_stat_fns$correlation) |>
  pggf_abline(intercept = y[type == 'control'] - x[type == 'control'])
```

Insulator fragments have a similar effect on enrichment with and without an upstream 35S enhancer.

```{r iDE correlation +/- 35S enhancer}
data_iDE_mean |>
  filter(enh_down != 'none') |>
  select(enh_up, enh_down, insulator, start, stop, orientation, enrichment) |>
  pivot_wider(
    names_from = enh_up,
    values_from = enrichment
  ) |>
  drop_na(none, `35S`) |>
  mutate(
    type = if_else(insulator == 'noIns', 'control', 'fragments'),
  ) |>
  pggfplot(
    filename = 'iDE_cor_35S',
    x = none,
    y = `35S`,
    facet_col = enh_down
  ) |>
  pggf_scatter(
    split = type
  ) |>
  pggf_stats(!! pggf_stat_fns$correlation) |>
  pggf_abline(intercept = y[type == 'control'] - x[type == 'control'])
```

Export data to a Supplementary Data file:

```{r iDE SuppData}
DS_id <- 3

data_iDE_export <- data_iDE_mean |>
  select(sys, enh_up, enh_down, insulator, start, stop, orientation, enrichment) |>
  pivot_wider(
    names_from = sys,
    values_from = enrichment
  ) |>
  arrange(enh_up, enh_down, insulator, orientation, start) |>
  mutate(
    sequence = str_sub(FLins_seqs[as.character(insulator)], start, stop),
    sequence = if_else(
      orientation == 'rev',
      as.character(Biostrings::reverseComplement(Biostrings::DNAStringSet(replace_na(sequence, 'A')))),
      sequence
    ),
    sequence = replace_na(sequence, '')
  ) |>
  rename('upstream enhancer' = enh_up, 'downstream enhancer' = enh_down) |>
  mutate(
    insulator = str_replace(insulator, 'beta', 'β'),
    insulator = str_replace(insulator, 'lambda', 'λ')
  )

wb <- createWorkbook()

modifyBaseFont(wb, fontSize = 10, fontName = 'Arial')

addWorksheet(wb, sheetName = 'downstream enhancer')

writeData(
  wb,
  sheet = 1,
  paste0('Supplementary Data ', DS_id,' | Enrichment of insulator fragment constructs with a downstream enhancer.'),
  startCol = 1,
  startRow = 1
)

addStyle(wb, sheet = 1, style = xlsx_bold, rows = 1, cols = 1)
mergeCells(wb, sheet = 1, rows = 1, cols = seq_len(ncol(data_iDE_export)))

writeData(
  wb,
  sheet = 1,
  paste(
    "Insulator fragments were cloned upstream of a AB80 or Cab-1 enhancer and a 35S minimal promoter driving the expression of a barcoded",
    "GFP reporter gene. Half of the constructs also harbored a 35S enhancer upstream of the insulator fragments while the other half lacked",
    "an upstream enhancer (none). All constructs were pooled and subjected to Plant STARR-seq in tobacco leaves. Reporter mRNA enrichment",
    "was normalized to a control construct without an enhancer or insulator (noEnh; log2 set to 0)."
  ),
  startCol = 1,
  startRow = 2
)

addStyle(wb, sheet = 1, style = xlsx_wrap, rows = 2, cols = 1)
mergeCells(wb, sheet = 1, rows = 2, cols = seq_len(ncol(data_iDE_export)))
setRowHeights(wb, sheet = 1, rows = 2, heights = 12.75 * 5)

xlsx_header <- names(data_iDE_export)
enrichment_ids <- which(xlsx_header %in% c('tobacco', 'maize'))
xlsx_header[enrichment_ids] <- 'log2(enrichment)'

writeData(
  wb,
  sheet = 1,
  matrix(xlsx_header, nrow = 1),
  startCol = 1,
  startRow = 4,
  colNames = FALSE
)

addStyle(wb, sheet = 1, style = xlsx_boldwrap, cols = seq_along(xlsx_header), rows = 4)

writeData(
  wb,
  sheet = 1,
  data_iDE_export,
  startCol = 1,
  startRow = 5,
  headerStyle = xlsx_bold,
  keepNA = TRUE
)

mergeCells(wb, sheet = 1, rows = 4, cols = enrichment_ids)
addStyle(wb, sheet = 1, style = xlsx_center, rows = 4, cols = enrichment_ids, stack = TRUE)

for (i in seq_along(xlsx_header)[-enrichment_ids]) {
  mergeCells(wb, sheet = 1, rows = 4:5, cols = i)
}

addStyle(wb, sheet = 1, style = xlsx_2digit, cols = enrichment_ids, rows = 6:(nrow(data_iDE_export) + 6), gridExpand = TRUE)
addStyle(wb, sheet = 1, style = xlsx_seq_font, cols = which(xlsx_header == 'sequence'), rows = 6:(nrow(data_iDE_export) + 6))

setColWidths(wb, sheet = 1, cols = which(xlsx_header == 'downstream enhancer'), widths = 11.5)
setColWidths(wb, sheet = 1, cols = which(xlsx_header == 'log2(enrichment)'), widths = 16)

freezePane(wb, sheet = 1, firstActiveRow = 6)

saveWorkbook(wb, paste0(supp_data_dir, 'SupplementaryData', DS_id, '.xlsx'), overwrite = TRUE)
```

## Insulators or silencers?

To test if the insulator fragments act as insulators or silencers, we cloned them between the 35S enhancer and the 35S minimal promoter or upstream of both elements. This gave rise to the **i/sLib** library which showed high replicate correlations.

```{r i/sLib replicate correlation}
data_isLib_norm |>
  select(rep, sys, construct, insulator, start, stop, orientation, enrichment) |>
  filter(construct != 'control') |>
  pivot_wider(
    names_from = rep,
    names_prefix = 'rep',
    values_from = enrichment
  ) |>
  drop_na(starts_with('rep')) |>
  pggfplot(
    filename = 'isLib_cor_rep',
    x = rep1,
    y = rep2,
    facet_col = sys,
    scales = 'square'
  ) |>
  pggf_scatter(color = construct) |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

Insulator fragments reduce the enrichment of the reporter construct when the 35S enhancer is cloned upstream of them. When the insulator fragments reside upstream of the 35S enhancer, they are largely inactive.

```{r i/sLib enrichment}
data_isLib_mean |>
  group_by(sys) |>
  mutate(
    noIns = enrichment[insulator == 'noIns']
  ) |>
  ungroup() |>
  filter(type != 'control') |>
  mutate(
    construct = ordered(construct, levels = c('insulator', 'silencer'))
  ) |>
  pggfplot(
    filename = 'isLib_enrichment',
    x = construct,
    y = enrichment,
    facet_col = sys
  ) |>
  pggf_hline(unique(noIns)) |>
  pggf_violin()
```

We can plot the enrichment of the silencer constructs against the enrichment of the insulator constructs to see if the tested fragments behave more like insulators or silencers.

```{r i/sLib insulator vs silencer}
data_isLib_mean |>
  select(sys, construct, insulator, start, stop, orientation, enrichment) |>
  unite(
    'id',
    insulator,
    start,
    stop,
    orientation,
    na.rm = TRUE
  ) |>
  filter(construct != 'control') |>
  pivot_wider(
    names_from = construct,
    values_from = enrichment
  ) |>
  drop_na(insulator, silencer) |>
  pggfplot(
    filename = 'isLib_IvS',
    x = insulator,
    y = silencer,
    facet_col = sys,
    scales = 'square'
  ) |>
  pggf_trendline() |>
  pggf_stats(!! pggf_stat_fns$trendline) |>
  pggf_scatter()
```

Export data to a Supplementary Data file:

```{r i/sLib SuppData}
DS_id <- 4

data_isLib_export <- data_isLib_mean |> 
  select(sys, construct, insulator, start, stop, orientation, enrichment) |>
  pivot_wider(
    names_from = sys,
    values_from = enrichment
  ) |>
  arrange(construct, insulator, orientation, start, stop) |>
  mutate(
    sequence = str_sub(FLins_seqs[as.character(insulator)], start, stop),
    sequence = if_else(
      orientation == 'rev',
      as.character(Biostrings::reverseComplement(Biostrings::DNAStringSet(replace_na(sequence, 'A')))),
      sequence
    ),
    sequence = replace_na(sequence, ''),
    insulator = str_replace(insulator, 'beta', 'β'),
    insulator = str_replace(insulator, 'lambda', 'λ')
  )

wb <- createWorkbook()

modifyBaseFont(wb, fontSize = 10, fontName = 'Arial')

addWorksheet(wb, sheetName = 'insulator v silencer constructs')

writeData(
  wb,
  sheet = 1,
  paste0('Supplementary Data ', DS_id,' | Enrichment of insulator fragments in insulator and silencer constructs.'),
  startCol = 1,
  startRow = 1
)

addStyle(wb, sheet = 1, style = xlsx_bold, rows = 1, cols = 1)
mergeCells(wb, sheet = 1, rows = 1, cols = seq_len(ncol(data_isLib_export)))

writeData(
  wb,
  sheet = 1,
  paste(
    "Insulator fragments were cloned in between (insulator construct) or upstream of (silencer construct) a 35S enhancer and a 35S minimal",
    "promoter driving the expression of a barcoded GFP reporter gene. All constructs were pooled and subjected to Plant STARR-seq in",
    "tobacco leaves (tobacco) or maize protoplasts (maize). Reporter mRNA enrichment was normalized to a control construct without an",
    "enhancer or insulator (noEnh; log2 set to 0)."
  ),
  startCol = 1,
  startRow = 2
)

addStyle(wb, sheet = 1, style = xlsx_wrap, rows = 2, cols = 1)
mergeCells(wb, sheet = 1, rows = 2, cols = seq_len(ncol(data_isLib_export)))
setRowHeights(wb, sheet = 1, rows = 2, heights = 12.75 * 5)

xlsx_header <- names(data_isLib_export)
enrichment_ids <- which(xlsx_header %in% c('tobacco', 'maize'))
xlsx_header[enrichment_ids] <- 'log2(enrichment)'

writeData(
  wb,
  sheet = 1,
  matrix(xlsx_header, nrow = 1),
  startCol = 1,
  startRow = 4,
  colNames = FALSE
)

addStyle(wb, sheet = 1, style = xlsx_boldwrap, cols = seq_along(xlsx_header), rows = 4)

writeData(
  wb,
  sheet = 1,
  data_isLib_export,
  startCol = 1,
  startRow = 5,
  headerStyle = xlsx_bold,
  keepNA = TRUE
)

mergeCells(wb, sheet = 1, rows = 4, cols = enrichment_ids)
addStyle(wb, sheet = 1, style = xlsx_center, rows = 4, cols = enrichment_ids, stack = TRUE)

for (i in seq_along(xlsx_header)[-enrichment_ids]) {
  mergeCells(wb, sheet = 1, rows = 4:5, cols = i)
}

addStyle(wb, sheet = 1, style = xlsx_2digit, cols = enrichment_ids, rows = 6:(nrow(data_isLib_export) + 6), gridExpand = TRUE)
addStyle(wb, sheet = 1, style = xlsx_seq_font, cols = which(xlsx_header == 'sequence'), rows = 6:(nrow(data_isLib_export) + 6))

freezePane(wb, sheet = 1, firstActiveRow = 6)

saveWorkbook(wb, paste0(supp_data_dir, 'SupplementaryData', DS_id, '.xlsx'), overwrite = TRUE)
```

## Enhancer-insulator combinations

The results from the iDE and i/sLib libraries suggest that silencer activity of the insulator fragments could be affected by the downstream enhancer. To test this hypothesis, we cloned several full-length insulators and insulator fragments upstream or downstream of 9 different enhancers. This gave rise to the **ExI** library which showed high replicate correlations.

```{r ExI replicate correlation}
data_ExI_norm |>
  filter(construct != 'noEnh') |>
  select(rep, sys, construct, enhancer, insulator, start, stop, enrichment) |>
  pivot_wider(
    names_from = rep,
    names_prefix = 'rep',
    values_from = enrichment
  ) |>
  drop_na(starts_with('rep')) |>
  pggfplot(
    filename = 'ExI_cor_rep',
    x = rep1,
    y = rep2,
    facet_col = sys,
    scales = 'square'
  ) |>
  pggf_scatter(color = construct) |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

First, let's see how strong the different enhancers are.

```{r ExI enhancer strength}
data_ExI_enhancers |>
  group_by(enhancer) |>
  mutate(
    rank = unique(rank[sys == 'tobacco'])
  ) |>
  ungroup() |>
  mutate(
    enhancer = ordered(enhancer, levels = unique(enhancer[order(rank)]))
  ) |>
  pggfplot(
    filename = 'ExI_enhancers',
    x = enhancer,
    y = enrichment,
    facet_col = sys
  ) |>
  pggf_boxplot()
```

For each enhancer, we can compare the activity of the insulator fragments cloned downstream (insulator construct) or upstream (silencer construct) of the enhancer.

```{r ExI insulator vs silencer}
enh_order <- data_ExI_enhancers |>
  filter(sys == 'tobacco') |>
  distinct(enhancer, rank) |>
  arrange(desc(rank)) |>
  pull(enhancer)

data_ExI_IvS <- data_ExI_mean |>
  select(sys, construct, enhancer, insulator, start, stop, enrichment) |>
  mutate(
    construct = if_else(insulator == 'noIns', 'insulator/silencer', construct),
    enhancer = ordered(enhancer, levels = enh_order)
  ) |>
  separate_longer_delim(
    construct,
    delim = '/'
  ) |>
  unite(
    'id',
    insulator,
    start,
    stop,
    na.rm = TRUE
  ) |>
  filter(construct != 'noEnh') |>
  pivot_wider(
    names_from = construct,
    values_from = enrichment
  ) |>
  drop_na(insulator, silencer)

 data_ExI_IvS |>
   pggfplot(
    filename = 'ExI_IvS',
    x = insulator,
    y = silencer,
    facet_col = enhancer,
    facet_row = sys,
    scales = 'square'
  ) |>
  pggf_trendline() |>
  pggf_stats(!! pggf_stat_fns$trendline) |>
  pggf_scatter()
```

When we can compare the slope of these regression lines to the strength of the enhancer, we observe a decent correlation.

```{r ExI correlation between slope and enhancer strength}
data_ExI_IvS |>
  group_by(sys, enhancer) |>
  summarise(
    slope = lm(silencer ~ insulator)$coefficients[2],
    .groups = 'drop'
  ) |>
  inner_join(
    data_ExI_enhancers |>
      group_by(sys, enhancer) |>
      summarise(
        enrichment = median(enrichment),
        .groups = 'drop'
      ),
    by = c('sys', 'enhancer')
  ) |>
  pggfplot(
    filename = 'ExI_cor_slope',
    x = slope,
    y = enrichment,
    facet_col = sys
  ) |>
  pggf_trendline() |>
  pggf_stats(!! pggf_stat_fns$correlation) |>
  pggf_scatter()
```

Export data to a Supplementary Data file:

```{r ExI SuppData}
DS_id <- 5

data_ExI_export <- data_ExI_mean |>
  select(sys, construct, enhancer, insulator, start, stop, enrichment) |>
  pivot_wider(
    names_from = sys,
    values_from = enrichment
  ) |>
  arrange(construct, enhancer, insulator, start, stop) |>
  mutate(
    sequence = str_sub(FLins_seqs[as.character(insulator)], start, stop),
    sequence = replace_na(sequence, ''),
    insulator = str_replace(insulator, 'beta', 'β'),
    insulator = str_replace(insulator, 'lambda', 'λ')
  )

wb <- createWorkbook()

modifyBaseFont(wb, fontSize = 10, fontName = 'Arial')

addWorksheet(wb, sheetName = 'enhancer-insulator combinations')

writeData(
  wb,
  sheet = 1,
  paste0('Supplementary Data ', DS_id,' | Enrichment of insulator and silencer constructs with eight different enhancers.'),
  startCol = 1,
  startRow = 1
)

addStyle(wb, sheet = 1, style = xlsx_bold, rows = 1, cols = 1)
mergeCells(wb, sheet = 1, rows = 1, cols = seq_len(ncol(data_ExI_export)))

writeData(
  wb,
  sheet = 1,
  paste(
    "Selected insulators and insulator fragments were cloned in between (insulator construct) or upstream of (silencer construct) an enhancer",
    "and a 35S minimal promoter driving the expression of a barcoded GFP reporter gene. Eight different enhancers were used to build these",
    "constructs. All constructs were pooled andsubjected to Plant STARR-seq in tobacco leaves (tobacco) or maize protoplasts (maize).",
    "Reporter mRNA enrichment was normalized to a control construct without an enhancer or insulator (noEnh; log2 set to 0)."
  ),
  startCol = 1,
  startRow = 2
)

addStyle(wb, sheet = 1, style = xlsx_wrap, rows = 2, cols = 1)
mergeCells(wb, sheet = 1, rows = 2, cols = seq_len(ncol(data_ExI_export)))
setRowHeights(wb, sheet = 1, rows = 2, heights = 12.75 * 5)

xlsx_header <- names(data_ExI_export)
enrichment_ids <- which(xlsx_header %in% c('tobacco', 'maize'))
xlsx_header[enrichment_ids] <- 'log2(enrichment)'

writeData(
  wb,
  sheet = 1,
  matrix(xlsx_header, nrow = 1),
  startCol = 1,
  startRow = 4,
  colNames = FALSE
)

addStyle(wb, sheet = 1, style = xlsx_boldwrap, cols = seq_along(xlsx_header), rows = 4)

writeData(
  wb,
  sheet = 1,
  data_ExI_export,
  startCol = 1,
  startRow = 5,
  headerStyle = xlsx_bold,
  keepNA = TRUE
)

mergeCells(wb, sheet = 1, rows = 4, cols = enrichment_ids)
addStyle(wb, sheet = 1, style = xlsx_center, rows = 4, cols = enrichment_ids, stack = TRUE)

for (i in seq_along(xlsx_header)[-enrichment_ids]) {
  mergeCells(wb, sheet = 1, rows = 4:5, cols = i)
}

addStyle(wb, sheet = 1, style = xlsx_2digit, cols = enrichment_ids, rows = 6:(nrow(data_ExI_export) + 6), gridExpand = TRUE)
addStyle(wb, sheet = 1, style = xlsx_seq_font, cols = which(xlsx_header == 'sequence'), rows = 6:(nrow(data_ExI_export) + 6))

freezePane(wb, sheet = 1, firstActiveRow = 6)

saveWorkbook(wb, paste0(supp_data_dir, 'SupplementaryData', DS_id, '.xlsx'), overwrite = TRUE)
```

## Silencer constructs in stable lines

We also tested some of the full-length insulators in a silencer construct in stable *Arabidopsis* lines.

```{r FLsil dual-luciferase activity}
data_DL |>
  filter(set %in% c('FLsil', 'silAB') | (insulator %in% c('noEnh', 'noIns') & set == 'insAB')) |>
  pggfplot(
    filename = 'DL_sil',
    x = insulator,
    y = l2ratio,
    facet_col = enhancer
  ) |>
  pggf_hline(median(y[xticklabels == 'noIns'])) |>
  pggf_boxplot()
```

These results closely match our Plant STARR-seq measurements in tobacco ...

```{r FLsil dual-luciferase correlation}
data_DL_sil_summary <- data_DL |>
  filter(set %in% c('FLsil', 'silAB') | (insulator %in% c('noEnh', 'noIns') & set == 'insAB')) |>
  group_by(enhancer, insulator) |>
  summarise(
    CI = 0.5 * diff(t.test(l2ratio)$conf.int),
    l2ratio = mean(l2ratio),
    .groups = 'drop'
  )

data_ExI_mean |>
  mutate(
    enhancer = if_else(insulator == 'noEnh', '35S/AB80', enhancer)
  ) |>
  separate_longer_delim(
    enhancer,
    delim = '/'
  ) |>
  filter(sys == 'tobacco' & enhancer %in% c('35S', 'AB80') & (insulator %in% c('noEnh', 'noIns') | (type == 'FL' & construct == 'silencer'))) |>
  group_by(enhancer, insulator) |>
  summarise(
    enrichment = mean(enrichment),
    .groups = 'drop'
  ) |>
  inner_join(
    data_DL_sil_summary,
    by = c('enhancer', 'insulator')
  ) |>
  pggfplot(
    filename = 'DL_cor_sil',
    x = enrichment,
    y = l2ratio,
    facet_col = enhancer
  ) |>
  pggf_trendline() |>
  pggf_scatter(
    color = insulator,
    y_error = CI
  ) |>
  pggf_stats(!! pggf_stat_fns$correlation)
```

Similar to our findings in tobacco, the slope of the `silencer ~ insulator` regression line is higher for the *AB80* enhancer as compared to the slope for the 35S enhancer. 

```{r DL IvS slopes}
data_DL |>
  filter(grepl('ins|sil', set)) |>
  mutate(
    construct = if_else(grepl('ins', set), 'insulator', 'silencer'),
    construct = if_else(enhancer == 'AB80' & grepl('no', insulator, fixed = TRUE), 'insulator/silencer', construct)
  ) |>
  group_by(construct, 'id' = insulator, enhancer) |>
  summarise(
    l2ratio = mean(l2ratio),
    .groups = 'drop'
  ) |>
  separate_longer_delim(
    construct,
    delim = '/'
  ) |>
  pivot_wider(
    names_from = construct,
    values_from = l2ratio
  ) |>
  group_by(enhancer) |>
  mutate(
    slope = (silencer[id == 'noIns'] - silencer[id == 'noEnh']) / insulator[id == 'noIns'],
    intercept = silencer[id == 'noEnh']
  ) |>
  ungroup() |>
  filter(id != 'noEnh') |>
  pggfplot(
    filename = 'DL_IvS',
    x = insulator,
    y = silencer,
    facet_col = enhancer,
    scales = 'square'
  ) |>
  pggf_trendline() |>
  pggf_stats(!! pggf_stat_fns$trendline) |>
  pggf_scatter() |>
  pggf_abline(slope = unique(slope), intercept = unique(intercept))
```
